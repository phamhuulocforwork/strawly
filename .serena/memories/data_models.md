# Data Models & Entities

## Architecture Pattern

The project uses **Clean Architecture** with clear separation between:

- **Domain Entities** (`/lib/domain/entities/`) - Pure business objects
- **Data Models** (`/lib/data/models/`) - Persistence layer with Hive annotations

## Domain Layer

### Cycle Entity

**Location**: `/lib/domain/entities/cycle.dart`

```dart
class Cycle extends Equatable {
  final String id;
  final DateTime startDate;
  final int? cycleLength;        // null if ongoing
  final int? periodDuration;     // menstruation duration
  final String? notes;
  final DateTime createdAt;
  final DateTime updatedAt;
}
```

#### Key Features

- **Immutable**: Uses `const` constructor and final fields
- **Equality**: Extends `Equatable` for value-based comparison
- **Computed Properties**:
  - `isComplete`: Returns `cycleLength != null`
  - `endDate`: Calculates cycle end date if complete

#### Methods

- `copyWith()`: Create modified copy (immutability pattern)
- `toString()`: Debug-friendly string representation

### CycleStatistics Entity

**Location**: `/lib/domain/entities/cycle_statistics.dart`

```dart
class CycleStatistics extends Equatable {
  final double averageCycleLength;
  final double standardDeviation;
  final int totalCycles;
  final int completeCycles;
  final bool isRegular;
  final DateTime? predictedNextStartDate;
  final int? daysUntilNextPeriod;
  final double regularityScore;      // 0-100
}
```

Provides comprehensive statistics about user's cycle history.

## Data Layer

### CycleModel

**Location**: `/lib/data/models/cycle_model.dart`

```dart
@HiveType(typeId: HiveTypeIds.cycle)
class CycleModel extends HiveObject {
  @HiveField(0) String id;
  @HiveField(1) DateTime startDate;
  @HiveField(2) int? cycleLength;
  @HiveField(3) int? periodDuration;
  @HiveField(4) String? notes;
  @HiveField(5) DateTime createdAt;
  @HiveField(6) DateTime updatedAt;
}
```

#### Key Features

- **Hive Persistence**: Annotated with `@HiveType` and `@HiveField`
- **Type Safety**: Uses `typeId: HiveTypeIds.cycle` from constants
- **Generated Code**: `cycle_model.g.dart` generated by `hive_generator`
- **Mutable**: Extends `HiveObject` for Hive operations

#### Conversion Methods

##### To Domain Entity

```dart
Cycle toEntity() {
  return Cycle(
    id: id,
    startDate: startDate,
    // ... other fields
  );
}
```

##### From Domain Entity

```dart
factory CycleModel.fromEntity(Cycle cycle) {
  return CycleModel(
    id: cycle.id,
    startDate: cycle.startDate,
    // ... other fields
  );
}
```

##### JSON Serialization

```dart
factory CycleModel.fromJson(Map<String, dynamic> json) {
  return CycleModel(
    id: json['id'] as String,
    startDate: DateTime.parse(json['startDate'] as String),
    // ... other fields
  );
}

Map<String, dynamic> toJson() {
  return {
    'id': id,
    'startDate': startDate.toIso8601String(),
    // ... other fields
  };
}
```

Used for backup/restore functionality.

## Type ID Management

**Location**: `/lib/core/constants/hive_type_ids.dart`

```dart
class HiveTypeIds {
  static const int cycle = 0;
  // Future types can be added: settings = 1, backup = 2, etc.
}
```

Centralized management prevents type ID conflicts.

## Data Flow

### Saving to Database

```
Domain Entity (Cycle)
  ↓ fromEntity()
Data Model (CycleModel)
  ↓ Hive save()
Encrypted Storage
```

### Reading from Database

```
Encrypted Storage
  ↓ Hive retrieve
Data Model (CycleModel)
  ↓ toEntity()
Domain Entity (Cycle)
  ↓
Use Cases / ViewModels
```

## Key Design Patterns

### 1. Adapter Pattern

- CycleModel acts as adapter between domain and persistence
- Converts between Entity ↔ Model

### 2. Value Object Pattern

- Both Cycle and CycleStatistics are immutable value objects
- Use Equatable for value-based equality

### 3. Builder Pattern

- `copyWith()` methods allow creating modified copies
- Maintains immutability

## Field Descriptions

### Cycle/CycleModel Fields

| Field          | Type     | Description                            | Nullable      |
| -------------- | -------- | -------------------------------------- | ------------- |
| id             | String   | UUID identifier                        | No            |
| startDate      | DateTime | Cycle start date (first day of period) | No            |
| cycleLength    | int      | Days from start to next cycle start    | Yes (ongoing) |
| periodDuration | int      | Days of menstruation                   | Yes           |
| notes          | String   | User notes (symptoms, mood, etc.)      | Yes           |
| createdAt      | DateTime | Record creation timestamp              | No            |
| updatedAt      | DateTime | Last modification timestamp            | No            |

### CycleStatistics Fields

| Field                  | Type      | Description                 |
| ---------------------- | --------- | --------------------------- |
| averageCycleLength     | double    | Mean cycle length           |
| standardDeviation      | double    | Cycle length variability    |
| totalCycles            | int       | Total recorded cycles       |
| completeCycles         | int       | Cycles with known length    |
| isRegular              | bool      | Whether cycles are regular  |
| predictedNextStartDate | DateTime? | Predicted next period start |
| daysUntilNextPeriod    | int?      | Days until next period      |
| regularityScore        | double    | 0-100 regularity score      |

## Best Practices

1. **Always use entities in domain layer** - Never pass models to use cases
2. **Always use models in data layer** - Never pass entities to data sources
3. **Convert at repository boundary** - Repository handles entity ↔ model conversion
4. **Keep entities immutable** - Use `copyWith()` for modifications
5. **Use Equatable** - Enables value-based comparisons in tests and logic
